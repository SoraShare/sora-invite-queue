name: Deploy Backend to Supabase

on:
  push:
    branches: [ main ]
    paths:
      - "backend/supabase/**"
      - ".github/workflows/deploy-supabase.yml"

env:
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
  SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}

jobs:
  # Backend Deployment (Supabase Only)
  deploy-backend:
    name: Deploy Backend to Supabase
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Verify Supabase CLI Installation
        run: |
          export PATH="$HOME/.supabase/bin:$PATH"
          supabase --version
          echo "‚úÖ Supabase CLI installed successfully"

      - name: Verify Supabase Connection
        working-directory: backend
        run: |
          export PATH="$HOME/.supabase/bin:$PATH"
          echo "üîó Linking to Supabase project: $SUPABASE_PROJECT_REF"
          supabase link --project-ref $SUPABASE_PROJECT_REF

      - name: Validate Database Schema
        working-directory: backend
        run: |
          export PATH="$HOME/.supabase/bin:$PATH"
          echo "üîç Validating database migrations..."
          supabase db diff --linked --schema public

      - name: Deploy Database Migrations
        working-directory: backend
        run: |
          export PATH="$HOME/.supabase/bin:$PATH"
          echo "üìä Deploying database schema to Supabase..."
          supabase db push --linked

      - name: Deploy Edge Functions
        working-directory: backend
        run: |
          export PATH="$HOME/.supabase/bin:$PATH"
          echo "‚ö° Deploying edge functions..."
          supabase functions deploy --project-ref $SUPABASE_PROJECT_REF --no-verify-jwt

      - name: Verify Deployment
        working-directory: backend
        run: |
          export PATH="$HOME/.supabase/bin:$PATH"
          echo "‚úÖ Verifying Supabase deployment..."
          supabase projects list
          echo "Backend deployment completed successfully!"

      - name: Deployment Summary
        run: |
          echo "üéâ Backend Deployment Complete!"
          echo "================================"
          echo "‚úÖ Database migrations deployed"
          echo "‚úÖ Edge functions deployed"
          echo "üîó Supabase Project: $SUPABASE_PROJECT_REF"
          echo ""
          echo "Note: Frontend deployment handled separately by Cloudflare Pages"