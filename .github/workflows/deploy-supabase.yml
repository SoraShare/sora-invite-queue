name: Deploy Backend to Supabase

on:
  push:
    branches: [ main ]
    paths:
      - "backend/supabase/**"
      - ".github/workflows/deploy-supabase.yml"

env:
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
  SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}

jobs:
  # Backend Deployment (Supabase Only)
  deploy-backend:
    name: Deploy Backend to Supabase
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install Supabase CLI
        run: |
          curl -fsSL https://supabase.com/install.sh | sh
          echo "$HOME/.supabase/bin" >> $GITHUB_PATH

      - name: Verify Supabase CLI Installation
        run: |
          export PATH="$HOME/.supabase/bin:$PATH"
          supabase --version
          echo "âœ… Supabase CLI installed successfully"

      - name: Verify Supabase Connection
        working-directory: backend
        run: |
          export PATH="$HOME/.supabase/bin:$PATH"
          echo "ğŸ”— Linking to Supabase project: $SUPABASE_PROJECT_REF"
          supabase link --project-ref $SUPABASE_PROJECT_REF

      - name: Validate Database Schema
        working-directory: backend
        run: |
          export PATH="$HOME/.supabase/bin:$PATH"
          echo "ğŸ” Validating database migrations..."
          supabase db diff --linked --schema public

      - name: Deploy Database Migrations
        working-directory: backend
        run: |
          export PATH="$HOME/.supabase/bin:$PATH"
          echo "ğŸ“Š Deploying database schema to Supabase..."
          supabase db push --linked

      - name: Deploy Edge Functions
        working-directory: backend
        run: |
          export PATH="$HOME/.supabase/bin:$PATH"
          echo "âš¡ Deploying edge functions..."
          supabase functions deploy --project-ref $SUPABASE_PROJECT_REF --no-verify-jwt

      - name: Verify Deployment
        working-directory: backend
        run: |
          export PATH="$HOME/.supabase/bin:$PATH"
          echo "âœ… Verifying Supabase deployment..."
          supabase projects list
          echo "Backend deployment completed successfully!"

      - name: Deployment Summary
        run: |
          echo "ğŸ‰ Backend Deployment Complete!"
          echo "================================"
          echo "âœ… Database migrations deployed"
          echo "âœ… Edge functions deployed"
          echo "ğŸ”— Supabase Project: $SUPABASE_PROJECT_REF"
          echo ""
          echo "Note: Frontend deployment handled separately by Cloudflare Pages"